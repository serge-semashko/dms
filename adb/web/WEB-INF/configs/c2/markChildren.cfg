[parameters]
service=dubna.walt.service.TableServiceSpecial
KeepLog=true
table_beg=none
wrapperTable=none
table_end=none
$INCLUDE menu.cfg[tables]
[end]


[report header]
$SET_PARAMETERS currentRow=0;
<br>Помечаем оплаченные дочерние документы в ADB2... ??!mode=auto
[end]

[item]
#PID#; #SCALE#<br>
$GET_DATA [setChildrenSums]
DOC_LIST=#DOC_LIST# ??
. ??BATCH=0&!mode=auto
$GET_DATA [commit] ??BATCH=0
[end]

[setChildrenSums]
+++ проставляем суммы 1С потомкам в соответствии с к-том оплаты ??
update docs set 
 S_1C_RUB=SUMMA_RUB*#SCALE#
,S_1C_USD=SUMMA_USD*#SCALE#
,S_1C_EUR=SUMMA_EUR*#SCALE#
where pid=#PID#
[end]


[report footer]
ОК  ??!ERROR&!GET_DATA_ERROR
[end]


=======================================================================

[preSQLs]
[end]


[SQL]
+++ Выбираем все оплаченные сводные и к-т оплаты ??
    у которых рублевая сумма по потомкам НЕ сходится с 1С ??
select d.doc_id as "PID"
, SUM_CHILDREN, S_1C_RUB ??
, to_char(d.S_1C_RUB/d.SUM_CHILDREN,'99999999990.0000') as "SCALE"
, mod(ROWNUM,100) as "BATCH"
from docs d 
where IS_TOTAL='Y' and payed is not null
and abs(SUM_CHILDREN-S_1C_RUB)/SUM_CHILDREN>=0.005
and SUM_CHILDREN>0 and S_1C_RUB>0
[end]

------------------------------------------------------

[commit]
commit;
[end]

