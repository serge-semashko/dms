c3/zakaz_list.cfg


[parameters]
service=dubna.walt.service.TableServiceSpecial2  ??!form=y
title=1С-заказы поставщику

debug=off
debug=on  ??uname=sergZZZ

makeTotalsForCols=SUMM_RUB,SUMM_USD,
  ??f_curr&!f_curr=other
totRowLabel=Всего

LOG=ON
tableCfg=nica/table.cfg 
tableCfg=this ??
wrapperTable=none 
table_beg=none
table_end=none
wrapperTableEnd=none 

thsnDelimiter=&nbsp;
numDigits=2

lab_codes=032,090,100,200,300,400,500,600,700
infr_codes=001,006,009,010,016,021,023,024,026,028,042,900,990,935

$INCLUDE common.dat[colors]
[end]


[report]
$SET_PARAMETERS f_bud=on;
$INCLUDE [logged report header] ??M_1C_PLAT>0
</td></tr></table>
</td></tr></table>
</form></center>
</body></HTML>
[end]


[report header]
$INCLUDE [logged report header]   ??M_1C_PLAT>0&logged|det=y
<script>window.location.href="#loginURL#?back_url=#ServerPath##ServletPath#";</script> ??!logged&!det=y
[end]


[logged report header]
    <HTML><HEAD><TITLE>#title#</TITLE>
    <META http-equiv=Content-Type content="text/html; charset=windows-1251">
    $INCLUDE c3/head.dat[head]


    <body bgcolor=F4FFFA>
    <style> fieldset {background-color:white;} </style>
    $SET_PARAMETERS srn=1; rpp=20  ??!rpp
    $SET_PARAMETERS dsumm=1 ??!dsumm
    $SET_PARAMETERS f_year=20#q_yr#; f_bud=bud; ??form=y

    $GET_DATA [getTotals] ??!form=y&ZZZZZ

    <table border=0 cellpadding=0 cellspacing=0 style="margin:20px; width:98%"><tr><td width=90%>
        <h3>1C - заказы поставщику</td><td align=right nowrap=true></td><td align=right nowrap=true>
        <a class=info href="/adb/adb">Главная</a></td></tr>
    </table>

    <form name="theForm" method="POST" enctype="multipart/form-data">
    <input type=hidden name="c" value="#c#">
    <input type=hidden name="srn" value="#srn#">
    <input type=hidden name="srt" value="#srt#">
    <input type=hidden name="desc" value="#desc#">
    <input type=hidden name="noTable" value="">

    <center>
    <FIELDSET style="background-color: ##E8F0F8; display:inline-block;"><LEGEND><b><i>Отобрать данные:</i></b></LEGEND>
        <table border=0 cellpadding=4 >
            <tr>
                <td align=right nowrap=true>Заказ №: </td><td><input class=xp size=12 name="f_reg" value='#f_reg#'></td>
            </tr>
            <tr><td align=right nowrap=true>Дата документа:</td><td>
                    $INCLUDE common.dat[dat] param: fd_name=startdate; fd_val=#startdate#; yr1=-4; yr2=1; class=xp;
                    &nbsp;&nbsp;[по: 
                    $INCLUDE common.dat[dat] param: fd_name=enddate; fd_val=#enddate#; yr1=-4; yr2=1; class=xp;
                ]</td>
            </tr>

            <tr><td align=right nowrap=true>Контрагент: </td><td><input class=xp size=25 name="f_contrag" value='#f_contrag#'></td></tr>
            <tr><td align=right nowrap=true>Рег. №№ ADB2: </td><td><input class=xp size=25 name="f_Adb2Nr" value='#f_Adb2Nr#'></td></tr>
            <tr><td nowrap=true align=right>
                Сумма:</td><td nowrap=true>
                <select name=f_summa_op onChange="setDsumm()"><option>=<option>&gt;<option>&lt;</select>
                <input class=xp size=8 name="f_summa" value='#f_summa#'> руб.
                <span id=s_dsumm style="display:inline"><b>+- </b><input class=xp size=1 name="dsumm" value='#dsumm#'></span>
            </td></tr>

            <tr>
                <td style="text-align:right;" colspan=2><input class="b_nica bok" type=submit value=" Выполнить" onClick="return doIt();"></td>
            </tr>

        </table>
    </FIELDSET>
    ........................................................................??

    $INCLUDE [script]  

    <iframe width=900 height=1 name="wf" id="wf" scrolling="auto" frameborder="0" style="border:none 1px ##607080;"></iframe>  

    <div id=cont>
    $INCLUDE [table_title]  ??!form=y
[end]


[table_title]
$SET_PARAMETERS DD_REPORT=Y; ??REQ_LINK|RD_LINK
<table class="tlist" border=0 cellspacing=0 cellpadding=0 style="margin:20px;">
    <tr>
        <th>Заказ</th>
        <th>Контрагент</th>
        <th>Счет</th>
        <th>Номенклатура</th>
        <th >Сумма в валюте</th>
        <th class="srh" sr="p.PLAT_SUMM_RUB">руб.</th>
        <th class="srh" sr="p.S_US">USD</th>

        <th>Подразд.</th>
        <th class="srh" sr="p.SUBJECT">NICA</th>
        <th>Приказ</th> ??
        <th>НИКА</th> ??
        <th class="srh" sr="b.AGGR">статья<br>бюдж.</th>

        $INCLUDE c2/factList_gen.dat[ADB head] ??
        <th class="srh" sr="p.ADB2_NUM">ADB2<br>документ</th> 
    </tr>
[end]

[item]
    <tr>
        <td>#DOC#</td> ??
        <td class="align_left">
            <a href="#ServletPath#?c=c3/zakaz&f_ref=#REF#"  ??!prn
                target="Zakaz#DOC_NR#" ??!DETAILS&!prn
            > ??!prn
            #DOC_NR#
            </a>,<small>  ??!prn
            #DOC_DATE#
            <BR> ??!prn
            #RESP#
            #REQUEST_NR#,<small>#REQ_DAT#<BR>#RESP# ??
            </SMALL> ??!prn
        </td> 

        <td class_="align_center">#KONTRAGENT#</td>

        <td>№#SCHET_NR# от #SCHET_DAT#<br>
            <small>#JINR_DEST#
                , #JINR_INITIATOR#  ??!JINR_INITIATOR=#RESP#
            </small>
        </td>
        <td><div style="max-width:250px;">#NOMENKLATURA#</div></td>

        <td class="align_right">#SUMMA# #CURRENCY#&nbsp;</td>

        <td class="align_right">&nbsp;
            #SUMM_RUB#  ??!CURR_CODE=810
            <b>#SUMM_RUB#</b>  ??CURR_CODE=810
        </td>
        <td class="align_right">&nbsp;
            #SUMM_USD#          ??!CURR_CODE=840
            <b>#SUMM_USD#</b>   ??CURR_CODE=840
        </td>
        <td>&nbsp;#DIV#</td>
        <td><a href="javascript:showAdb2('#N_ADB#')">#NICA_CODE#</a>  

        <td><a href="javascript:showAdb2('#N_ADB#')">#N_ADB#</a>  
    </tr>
[end]

[SQL]
select 
      ''''||z.DOC_NR as DOC_NR
    , to_char(z.DOC_DATE, 'DD.MM.YYYY') as DOC_DATE
    , z.KONTRAGENT
    , ''''||z.SCHET_NR as "SCHET_NR"
    , z.SUMMA
    , to_char(nvl(z.SUMM_RUB,0),'99999999990D00') as SUMM_RUB
    , to_char(nvl(z.SUMM_USD,0),'99999999990D00') as SUMM_USD
    , z.CURRENCY, z.CURR_CODE
    , z.REF
    , to_char(z.SCHET_DAT, 'DD.MM.YYYY') as SCHET_DAT, z.JINR_DEST
    , z.NICA_CODE, z.JINR_NICA
    , z.RESP, z.JINR_INITIATOR
    , z.NOMENKLATURA
    , ''''||N_ADB as "N_ADB"

    , DOC
        , KURS, DAT_OPL
        , DIV, COMMENTS, SKLAD, ORG, BANK_SCHET, DATE_UPD, JINR_SOURCE
    from c3_zakaz_postav z
    where 1=1
[end]


[numDigitsForCols]
DOC_NR=0
CURR_CODE=0
N_ADB=0
SCHET_NR=0
SUMM_RUB=2
SUMM_USD=2
[end]



[report footer]
        <tr class=blue><td colspan=15 class="align_left">
        $INCLUDE common.dat[rpp]  param: noTR=Y; ??!NumTableRows=0
        <input type=hidden name="rpp" value="#rpp#"> ??NumTableRows=0|node_id=0
        </TD></TR></TABLE>  
    </form></center>
    srt=#srt# ??
    <script type="text/javascript">
        bindEvents();
        showSrt("#srt#","sup"); ??!desc
        showSrt("#srt#","sdown"); ??desc
        window.focus();
    </script>
    </body></HTML>
[end]

[script]
    <script type="text/javascript">
        var frm=document.theForm;
        window.focus();
        selectOptionByVal(frm.f_summa_op,'#f_summa_op#')  ??f_summa_op

        function getPP(nomPlat, dat)
        {
            openWindow("c=c2/platList&f_platNr=" + nomPlat, "plat", 1000,800);
        }

        function setDsumm()
        { if (frm.f_summa_op.options.selectedIndex == 0)
            document.getElementById("s_dsumm").style.display="inline";
          else 
            document.getElementById("s_dsumm").style.display="none";
        }
        setDsumm();

        function showAdb2(num)
        {  openWindow("c=doc/docEdit&DOC_ID=" + num,"adb2doc",1030,700);
        }


        function goToRow(nr)
        { if (!checkFields()) return false;
          frm.srn.value=nr;  
        //  alert (frm.srn.value);
          frm.submit();
          return true; 
        }

        function doIt()
        { if (!checkFields()) return false;
          frm.srn.value="1";
        //  alert ("here!");
          frm.submit();  
          return true;
        }

        function checkFields()
        { 
          if (!checkFloat("f_summa",null,null,"Сумма")) return false;   
          return true;
        }
    </script> 
[end]



================================ SQLs ================================
[preSQLs]
[end]



    select 
        to_char(b.DAT, 'DD.MM.YYYY') as "DAT"
        ,''''||to_char(b.PLANDAT, 'YYYY') as "PLANDAT"
        , b.REG_TYPE || ' '||REG_NR||'<br><small>'||to_char(b.REG_DAT, 'DD.MM.YYYY')||'</small>' as REGISTRATOR

        , ''''||b.REQUEST_NR as REQUEST_NR 
        , r.CONTRAGENT
        , ''''||b.DIV_CODE as DIV_CODE
        , ''''||b.SBJ as SBJ
        , ''''||b.AGGR as AGGR
        , b.S_RUB, b.S_USD, b.S_EUR
        , ''''||decode(nvl(b.ADB_NR,1),1,'-',b.ADB_NR) as ADB_NR 
        , b.S_RUB-d.SUMMA_RUB as "DIFF", d.SUMMA_RUB  ??!DD_REPORT
        , b.CURR_CODE
        , ''''||b.CONTSTOBOROTOV as CONTSTOBOROTOV

        , REG_TYPE, ''''||REG_NR as REG_NR, to_char(b.REG_DAT, 'DD.MM.YYYY') as REG_DAT
        , to_char(b.REQUEST_DAT, 'DD.MM.YYYY') as "REQ_DAT"
        , ''''||to_char(b.REQUEST_DAT, 'YY') as "REQ_YR"
        , R.RESP

        , b.SCENARII
        , b.CONTCFO, ''''||to_number(b.STOBOROTOV) as STOBOROTOV
        , to_char(b.Prikaz_Dat, 'DD.MM.YYYY') ||' п.'||b.PUNKT as PRIKAZ_PUNKT
        , ''''||b.PRIKAZ as PRIK_NR

        , b.PROJECTDET
        , ''''||d.AGGR as A_AGGR
        , ''''||d.LAB_CODE as D_LAB_CODE   ??labcheck|sbjcheck
        , ''''||bc.SBJ_CODE as SBJ_CODE   ??sbjcheck
        , c.MARK, ''''||c.OLD_ADB2_NUM as C_OLD_ADB2_NUM
        , ''''||c.ADB2_NUM as NEW_ADB2_NUM
        , c.COMMENTS as "C_COMMENTS"
        ,'"'||b.Prikaz_id||'"' as PRIKAZ_ID
    from 
    C2_BudgetFact b
        left join C2_Requests r on r.REQ_NR=b.REQUEST_NR ??
        left join C2_Requests r on (r.REQ_NR=b.REQUEST_NR and r.REQ_DATE=b.REQUEST_DAT)
        left join docs d on d.doc_id=b.ADB_NR
        left join c2_fact_corr_#q_yr# c on (c.REQ=b.REQUEST_NR and c.REG=b.REG_NR )
        left join bc bc on bc.code=d.bc

    where 1=1
        and ISPRIHOD=0
        and ISBUDGET=1 ??f_bud=bud
        and ISBUDGET=0 ??f_bud=nobud
        and d.is_total='Y' ??svodcheck
        and c.mark=1  ??problem
        and c.mark is null  ??new&!problem
        and b.REG_NR=#f_reg# ??f_reg

        and b.REQUEST in('#REQ_LINK#') ??REQ_LINK
        and b.REQUEST in(select LINK from C2_Requests_#yr# where DOC_OSN='#RD_LINK#') ??RD_LINK&!REQ_LINK


        and b.REG_TYPE='#f_reg_type#'??f_reg_type
        and b.REQUEST_NR=#f_req# ??f_req

        $INCLUDE c2/factList_gen.dat[ADB2Criteria]   ??f_Adb2Nr

        and b.DIV_CODE IN()'#A_LABS#' ??A_LABS
        and b.DIV_CODE in(#f_lab#)  ??f_lab&!f_lab=XXX&!f_lab=NULL
        and not b.DIV_CODE in(000, #lab_codes#, #infr_codes#, 919, 011)  ??f_lab=XXX
        and b.DIV_CODE is null  ??f_lab=NULL
        and upper(r.CONTRAGENT) like upper('%#f_contrag#%') ??f_contrag

        and b.aggr IN()'#f_aggr#'  ??f_aggr&!f_aggr=NOT4
        and (d.aggr is null or d.aggr not IN('01','02','03','04'))  ??f_aggr=NOT4
        and b.aggr IN()'#ff_aggr#'  ??ff_aggr

        and (b.Prikaz_id is null or b.Prikaz_id=0) ??f_prik=NULL
        and not b.Prikaz_id is null and not b.Prikaz_id=0  ??f_prik=*
        and b.Prikaz||'/'|| to_char(b.PRIKAZ_DAT, 'DD.MM.YYYY')='#f_prik#' and b.punkt='#f_punkt#' ??f_prik&f_punkt&!f_prik=*&!f_prik=NULL
        and b.Prikaz||'/'|| to_char(b.PRIKAZ_DAT, 'DD.MM.YYYY')='#f_prik#'  ??f_prik&!f_punkt&!f_prik=*&!f_prik=NULL

        and b.S_RUB #f_summa_op# #f_summa# ??f_summa&!f_summa_op==
        and abs(b.S_RUB-#f_summa#) <= #dsumm#+0.5 ??f_summa&f_summa_op==

        and not d.LAB_CODE is null and to_number(d.LAB_CODE) <> b.DIV_CODE ??labcheck
        and (to_number(d.LAB_CODE)<>990 and b.DIV_CODE<>10 ) ??
        and b.aggr <> d.aggr ??aggrcheck

        and upper(b.SBJ)<>bc.SBJ_CODE and not bc.SBJ_CODE is null ??sbjcheck

        and extract(year from b.PLANDAT)='#f_year#' ??f_year
        and to_char(b.DAT, 'DD.MM.YYYY')='#startdate#'      ??startdate&!enddate
        and b.DAT between to_date('#startdate#', 'DD.MM.YYYY') and to_date('#enddate#', 'DD.MM.YYYY')      ??startdate&enddate
        and b.DAT <= to_date('#enddate#', 'DD.MM.YYYY')      ??enddate&!startdate

    order by  b.S_USD desc
[end]




