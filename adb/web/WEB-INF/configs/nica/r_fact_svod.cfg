r_fact_svod.cfg


r_svod_src.cfg

[parameters]
service=dubna.walt.service.TableServiceSpecial2 ??
debug=off
KeepLog=true
tableCfg=this
wrapperTable=none
table_beg=none
table_end=none
wrapperTableEnd=none
ROOT_ID=0
numDigits=0
YEARS_FACT=2014,2015,2016,2017
YEARS_PLAN=2018,2019,2020,2021,2022,2023
[end]


[report]
    $SET_PARAMETERS id=#curr_id#; 
    $SET_PARAMETERS format=99999999990D0; scale=1000;
    $SET_PARAMETERS format=99999999990D0; ??
    $SET_PARAMETERS f_source=ALL;       ??!f_source
    $CALL_SERVICE c=nica/i_projectParents; ??!curr_id=0

CHILDS=#CHILDS#; ??
    <style type="text/css">
        table.tlist td {text-align:right;}
        table.tlist tr.total td, table.tlist tr.total th {font-weight:bold; border-top:solid 1px black;}

    </style>

    <div style="padding:20px;">
        Источник:
        $INCLUDE [sources] 
        Конфигурация:
        $INCLUDE nica/common.dat[mega filter]
        <input type="radio" name="units" value="" onClick="refreshTable();"
            checked  ??!units
        > тыс.руб
        <input type="radio" name="units" value="USD" onClick="refreshTable();"
            checked  ??units=USD
        > тыс.USD
        <br>
        <input type="checkbox" name="showADB" onClick="refreshTable();"
            checked  ??showADB
        >Показывать данные регистрации АДБ
    </div>

    <div id="table">
        <table class="tlist" border=0 cellspacing=0 cellpadding=2 style="margin:10px;">

        <tr>
            <td></td>
            <td class="" 
                colspan=10  ??showADB
                colspan=5 ??!showADB
                style="text-align:center; background-color:white;">
            <b>ФАКТИЧЕСКИЕ ЗАТРАТЫ</b>
            <br>(по данным заявок и регистра "факт" 1С) ??!showADB
        </td>
            <td style="text-align:center; background-color:white;" 
                colspan=14 ??
                colspan=7
            >
            <div style="float:right; ">
                млн.руб ??scale=1000000&!units=USD
                тыс.руб ??scale=1000&!units=USD
                млн.USD     ??scale=1000000&units=USD
                тыс.USD     ??scale=1000&units=USD
            </div>
            <b>ПЛАНИРУЕМЫЕ ЗАТРАТЫ</b>
            <br>(по плану закупок Costbook)
        </td>
            <td class="" colspan=2 style="text-align:center; background-color:white;">
        </td></tr>

        </tr>

$SET_PARAMETERS fact_colspan=colspan=2; ??showADB
        <tr><th rowspan=2> </th>
            $SET_PARAMETERS year_colspan=colspan=2;   ??showADB
            $SET_PARAMETERS year_rowspan=rowspan=2;   ??!showADB
            $EXECUTE_LOOP year; #YEARS_FACT#; [year cell]  
            <th #fact_colspan# #year_rowspan#>Всего</th>  

            $SET_PARAMETERS year_colspan=colspan=2; year_rowspan=; ??
            $SET_PARAMETERS year_colspan=; year_rowspan=rowspan=2;
            $EXECUTE_LOOP year; #YEARS_PLAN#; [year cell]
            <th colspan=1 rowspan=2>Всего план</th>  
            <th rowspan=2>ВСЕГО</th>  
        </tr>

        <tr>
            $EXECUTE_LOOP year; #YEARS_FACT#; [subhead]  ??showADB
            $INCLUDE  [subhead]  ??showADB

            $EXECUTE_LOOP year; #YEARS_PLAN#; [subhead-plan] ??
            $INCLUDE [subhead-plan] ??
        </tr> 

            $EXECUTE_LOOP curr_id; #CHILDS#; [child row] 

            $SET_PARAMETERS curr_id=#id#; cl=total;
            $INCLUDE [child row]
            $SET_PARAMETERS curr_id=-1; CODE=; TITLE=<img src="#imgPath#alert.gif"> Пункт не указан или неверен:;
            $INCLUDE [child row]     ??showADB&id=0
        </table>

        $INCLUDE [note] ??id=0|id=1
        <a class="pt" href="#ServletPath#?c=nica/svs/setReqMega" target=_blank>s</a>
    </div>

    <script type="text/javascript">
        var refreshTable=function(){    
            $("##table").html("<BR><BR><CENTER>ЗАГРУЗКА...</CENTER><BR><BR>."); ??
            t_planfact();
        }
        var showDet=function(YR,prjId, cfg){
            var tm = (new Date()).getTime();
            openWindow("c=" + cfg + "&YR="+YR + "&PROJECT_ID=" + prjId + "&f_source=#f_source#&payed=y&det=y&f_mega=#f_mega#", "e_det"+tm,1000,620);
        }
    </script>

[end]



[year cell]
<th #year_colspan# #year_rowspan#>#year#</th> 
[end]

[child row]  ******* строка таблицы по подпункту curr_id или итог, если curr_id=-1
    $GET_DATA [get child]  ??!curr_id=-1
    <tr class="#cl#"><th 
        style="text-align:left;" ??!curr_id=#id#
        style="text-align:right;" ??curr_id=#id#
    >
        ВСЕГО:  ??curr_id=0
        Всего по ??curr_id=#id#&curr_id>0
        #CODE#: #TITLE#  ??!curr_id=0
        </th>
        $EXECUTE_LOOP year; #YEARS_FACT#; [year block];  

        $SET_PARAMETERS year=;
        $INCLUDE [year block]

        $EXECUTE_LOOP year; #YEARS_PLAN#; [plan block];    ??!curr_id=-1

        $SET_PARAMETERS year=;
        $INCLUDE [plan block]   ??!curr_id=-1
        <td> </td>
    </tr>
[end]

[year block] ****** ячейка ФАКТ по году (АДБ и 1С)
    $GET_DATA [yearSQL]   ??year
    $INCLUDE [ADB cell]   ??showADB
    <td>#C1_RUB#</td>  ??
    $GET_DATA [1C SQL]   ??!curr_id=-1
    <td 
        class="pt" onClick="showDet('#YR#','#curr_id#', 'c2/reqList');"  ??YR
    >#C1_FACT#</td>
    $SET_PARAMETERS SUMMA=; FACT=; C1=; C1_FACT=; YR=;
[end]

[ADB cell] ****** клетка АДБ
    $GET_DATA [ADB SQL]
    <td>#SUMMA_RUB#</td> ??
    <td 
        class="pt" onClick="showDet('#YR#','#curr_id#', 'nica/list_1');"  ??YR
    >#FACT#</td>
[end]


[plan block] ***** ячейка ПЛАН по году
    $GET_DATA [yearSQL] ??year
    $GET_DATA [costbook SQL]   ??!f_source|f_source<2|f_source=ALL
    <td>#TOT_CB#</td>
    <td>##</td>  ??
    $SET_PARAMETERS TOT_CB=; FACT=; C1_PLAN=; YR=;
[end]

========================================================
[get child]
    select CODE, nvl(TITLE,title_e) as TITLE, nvl(resp, resp_e) as RESP
    from nica_wbs where id=#curr_id#
[end]


[yearSQL]
    select substr('#year#',3) as "YR" from dual;
[end]


[costbook SQL]
    select trim(to_char(sum(
            SUMMA_RUB     ??!units=USD
            SUMMA_USD     ??units=USD
        )/#scale#,'#format#')) as "TOT_CB" 

    from nica_costbook_#VER# p 
    where 
        p.is_fact=0 and p.STATIA>0
        and YR in(#year#)  ??year
        and YR in(#YEARS_PLAN#)  ??!year
        and p.source in(0,3)   ??f_source=0
        and p.source in(1)   ??f_source=1
        and p.mega=#f_mega# ??f_mega
        and p.WBS_ID in(select ID from nica_wbs connect by prior id=pid start with id=#curr_id#) ??curr_id>-1

[end]

[ADB SQL]
    SELECT 
    $INCLUDE nica/r_listDocs_table.cfg[bc info] ??
	 
	to_char(sum(nvl(d.SUMMA_RUB,0))/#scale#,'#format#') as SUMMA
	, to_char(sum(nvl(
            d.FACT_RUB      ??!units=USD
            d.FACT_USD      ??units=USD
        ,0))/#scale#,'#format#') as FACT

    FROM docs d 
	left join bc b on b.code=d.BC
	left join i_prikaz ip on ip.id=b.prikaz_id
        left join nica_wbs_wu p on p.id=d.PROJECT_ID

    WHERE  1=1
        and (not d.PROJECT_ID is null
            or b.SBJ_CODE like '%1065'
            or b.PRIKAZ_ID=991 ??
            or b.code in(3807,4799,4800)  ??
            or b.PRIKAZ_ID=274
            )
        and (not d.PROJECT_ID is null and d.PROJECT_ID in(select ID from nica_wbs_wu connect by prior id=pid start with id=#curr_id#)) ??curr_id>-1
        and (d.PROJECT_ID is null or d.PROJECT_ID not in(select ID from nica_wbs_wu)) ??curr_id=-1
        and (d.is_total is null or not d.is_total='Y' or d.num_children=0)
        and (not d.payed is null) ??
        and d.FACT_RUB>0
        and (extract(year from d.PAYED)=#year#) ??year
        and (extract(year from d.PAYED) in(#YEARS_FACT#)) ??!year
        and b.prikaz_id is null  ??f_source=0
        and not b.prikaz_id is null and not b.PRIKAZ_ID=274 and ip.ISBUDGET=1 ??f_source=33
        and d.mega=#f_mega#  ??f_mega&!f_mega=null
        and d.mega is null  ??f_mega=null

extract(year from d.REG_DATE)=#year# or ??

	and b.SBJ_CODE in(#A_SBJS#) ??A_SBJS
        and b.PRIKAZ_ID=274 ??f_source=1
        and b.code in(3807,4799,4800)   ??f_source=2
        and b.PRIKAZ_ID=991 ??f_source=2_ZZZ
[end]

[1C SQL]
    SELECT
	sum(nvl(r.SUMM_RUB,0)) as C1_RUB ??
	to_char(sum(nvl(r.SUMM_RUB,0))/#scale#,'#format#') as C1  
	, to_char(sum(nvl(
            r.SUMM_RUB_FACT   ??!units=USD
            r.SUMM_USD_FACT   ??units=USD
        ,0))/#scale#,'#format#') as C1_FACT 

    from 
        C2_Requests_#YR# ??YR&ZZZ 
        C2_Requests 
            ??!YR 
        r
    left join docs d on d.doc_id=r.ADB_NR ??
    left join c2_req_corr c on (c.REQ=r.REQ_NR ) ??

    where 
        r.NICA_ID in(select ID from nica_wbs_wu connect by prior id=pid start with id=#curr_id#)  ??
        (r.NICA_ID  in(select ID from nica_wbs_wu connect by prior id=pid start with id=#curr_id#)) ??curr_id>-1
        and not r.NICA_ID is null
        and (upper(r.SBJ) like upper('1065%') or upper(r.SBJ) in('1065'))  ??curr_id=-1
        and (upper(r.SBJ) like upper('1065%') or upper(r.SBJ) in('1065'))     ??f_source=0
        and (r.NICA_ID is null or r.NICA_ID not in(select ID from nica_wbs_wu)) ??curr_id=-1
        and r.FACT_YR=20#YR# ??YR
        and r.SUMM_RUB_FACT is not null

        and (r.aggr is null or not r.aggr IN(1,2,3)) 
        and 
            (   ??f_source=1|f_source=ALL
                r.IS_BUDGET=1   
                or r.PROJECT_CODE=1413)   ??f_source=1|f_source=ALL
            ??f_source=0
        and r.PROJECT_CODE=1413   ??f_source=1
        and not (r.prikaz is null or r.prikaz=0)  ??f_source=33
        and (r.prikaz is null or r.prikaz=0) ??f_source=0
        and r.mega=#f_mega#  ??f_mega&!f_mega=null
        and r.mega is null  ??f_mega=null
[end]

    and (extract(year from r.REQ_DATE)=#year# or extract(year from r.payed )=#year#) ??year
    and (extract(year from r.REQ_DATE) in(#YEARS_FACT#) or extract(year from r.payed ) in(#YEARS_FACT#)) ??!year


, case when r.SUMM_RUB_FACT is null then r.SUMM_RUB else r.SUMM_RUB_FACT end as SUMM_RUB
, case when r.SUMM_USD_FACT is null then r.SUMM_USD else r.SUMM_USD_FACT end as SUMM_USD
, r.SUMM_RUB_FACT, r.SUMM_USD_FACT

, ''''||to_char(r.REQ_DATE, 'YY') as REQ_YR
, ''''||d.PROJECT_ID as ADB_NICA_ID
, c.MARK, ''''||c.OLD_ADB2_NUM as C_OLD_ADB2_NUM
, ''''||c.ADB2_NUM as NEW_ADB2_NUM
, c.COMMENTS as "C_COMMENTS"




	, decode(d.is_total,'Y', to_char(nvl(d.SUMMA_RUB,0),'99999999990D00')||'<br>(<a href="javascript:getChildren('''||d.doc_id||''')">'||to_char(nvl(d.sum_children,0),'99999999990D')||'</a>)',to_char(nvl(d.SUMMA_RUB,0),'99999999990D00'))  as SUMMA_RUB ??!type|type=mnts|type=ext 
  , decode(d.is_total,'Y', '<a href="javascript:getChildren('''||d.doc_id||''')">--'||to_char(nvl(d.sum_children,0),'99999999990D00')||'--</a>','-') as SUMMA_CHILD ??!type=mnts&svod=y|svod=n
  , decode(d.is_total,'Y', '<a href="javascript:getChildren('''||d.doc_id||''')">--'||to_char(nvl(d.sum_children,0),'99999999990D00')||'--</a>',nvl(d.sum_children,0)) as SUMMA_CHILD ??ZZZ&!type=mnts&svod=y|svod=n

	, decode(d.SUMMA_CURR,null,'',to_char(d.summa_curr,'999G999G999G990D')||decode(d.CURR_CODE,810,'р.',840,' $',978,' €',756,' CHF',826,' GBP')) SUMMA_CURR  ??!type=mnts&full_report=on|curr=y
	, to_char(d.SUMMA_USD,'999999999990D00')||decode(d.is_total,'Y', '*','') as SUMMA_USD

		, decode(d.FACT_RUB,0,'-',to_char(d.FACT_RUB,'99999999990.00')) as FACT_RUB 	

, d.is_total
  , d.is_kredit

,	case when not b.PRIKAZ_ID is null and ip.ISBUDGET=1 then 'P'
	when not b.PRIKAZ_ID is null and ip.ISBUDGET=0 then 'V'
	else '' end as SRC


[preSQLs]
    $SET_PARAMETERS curr_id=0; ??!curr_id

    select CODE, nvl(TITLE,title_e) as TITLE, nvl(resp, resp_e) as RESP
    from nica_wbs where id=#curr_id#
    ;
    select ','||id as CHILDS 
        , to_number(replace(replace(code ,'.','') ,'X','')) as "SORT"
    from nica_wbs 
    where pid=#curr_id#
    order by SORT
    ;
[end]



..............................................................................

[note]
*) 
С учетом платежа 2013г. BEVATECH OHG по п.1.6 на сумму 64.5 млн.руб (1.9 млн.$)
<a href="http://ak0211.jinr.ru:8084/adb/adb?c=nica/docEdit&type=ext&stype=ext&DOC_ID=149483" target=_blank>(док.149483 =>)</a>
<br>
<br><br>&nbsp;
[end]

[sources] 
    <select name=f_source onChange='refreshTable();'>
    <option value="ALL"> Все</option>  

    <option value=0 style="background-color:white;"
        selected ??f_source=0
    >Бюджет ОИЯИ</option>

    <option value=1 style="background-color:##A0FF80;"
        selected ??f_source=1
    >РФ</option>

    <option value=33 style="background-color:##FFFFA0;" 
        selected ??f_source=33
    >Приказы (все, кроме РФ)
    </option>

    </select>
    #f_source# ??
[end]

    <option value=2 style="background-color:##FFB080;" 
        selected ??f_source=2
    >ФРГ</option>

    <option value=3 style="background-color:##B0F0FF;" disabled
        selected ??f_source=3
    >Приказы (страны-участницы) 

    <option value=22 style="background-color:##FFA0FF;"  disabled
        selected ??f_source=22
    >Другие страны (?)</option>


[subhead]
    <th>ADB-всего</th> ??
    <th>ADB</th>  ??
    <th>1С-заявки</th> ??
    <th>ADB-факт</th>  
    <th>1С-факт</th>
[end]

[subhead-plan]
    <th>Costbook</th>
    <th>Контракты</th>  
[end]

SELECT
, to_char(sum(nvl(r.SUMM_RUB_FACT,0))/1000,'99G999G999G990D0') as C1_FACT
from
C2_Requests
r
where

and not r.NICA_ID is null
and (upper(r.SBJ) like upper('1065%') or upper(r.SBJ) in('1065'))
and r.SUMM_RUB_FACT is not null
and (r.aggr is null or not r.aggr IN(1,2,3))
and (r.prikaz is null or r.prikaz=0)
***** 1 record(s) retrieved. Filled 2 parameters: 
C1=        319 363.4
C1_FACT=        319 363.4


select
count(r.REQ_NR) as "NUM_RECS"
, to_char( sum(nvl(r.SUMM_RUB_FACT, 0)), '999G999G999G999') as "SUMM_RUB_FACT"
, to_char( sum(nvl(r.SUMM_USD_FACT, 0)), '999G999G999G999') as "SUMM_USD_FACT"
from
C2_Requests r
left join docs d on d.doc_id=r.ADB_NR
left join c2_budgetFact f on (f.REQUEST=r.LINK and f.REG_TYPE='ППИ')
where 1=1
and r.SUMM_RUB_FACT is not null
and (upper(r.SBJ) like upper('1065%') or upper(r.SBJ) in('1065'))
and (r.aggr is null or not r.aggr IN(1,2,3))
and (r.Prikaz is null or r.Prikaz=0)
***** 1 record(s) retrieved. Filled 7 parameters: 
NUM_RECS=163
REQ_SUMM_RUB=     322 124 096
REQ_SUMM_USD=       5 506 139
REQ_SUMM_RUB_W=               0
REQ_SUMM_USD_W=               0
SUMM_RUB_FACT=     322 124 096
SUMM_USD_FACT=       5 506 139