[parameters]
service=dubna.walt.service.TableServiceSortable  ??!form=y
title=1С-Платежи

debug=on  ??uname=sergZZ
debug=on ??

makeTotalsForCols=SCHET_SUM,SUM,SCHET_SUMM_RUB,PLAT_SUMM_RUB ??f_curr&!f_curr=other
makeTotalsForCols=SCHET_SUMM_RUB,PLAT_SUMM_RUB ??f_curr=other|!f_curr
totRowLabel=Всего
sortCols=SCHET,PLAT,PLAT_SUMM_RUB,SCHET_SUMM_RUB
tableCfg=table.cfg 
thsnDelimiter=&nbsp;
numDigits=2
lab_codes=032,090,100,200,300,400,500,600,700
infr_codes=001,006,009,010,016,021,023,024,026,028,042,900,990,935

$INCLUDE common.dat[colors]
[end]


[report]
$INCLUDE [logged report header]
</td></tr></table>
</td></tr></table>
</form></center>
<script> var d = new Date(); var dd = d.getDate(); var mm = d.getMonth()+1; ??
frm.startdate.value ="01." + mm + "." + d.getYear(); ??
frm.enddate.value ="31.12." + d.getYear(); ??
alert (dd + "." + mm + "." + d.getYear()); ??
</script> ??
</body></HTML>
[end]


[report header]
$INCLUDE [logged report header]   ??logged
<script>window.location.href="#loginURL#?back_url=#ServerPath##ServletPath#?#queryString#";</script> ??!logged
[end]


[logged report header]
$INCLUDE common.dat[head]
<body bgcolor=F4FFFA>
<style> fieldset {background-color:white;} </style>
$SET_PARAMETERS access_all=y ??USER_GROUP=sys|USER_GROUP=adm|USER_GROUP=boss|USER_GROUP=buh|USER_GROUP=developer
$SET_PARAMETERS srt=13; desc=DESC ??!srt&s_curr=s_curr
$SET_PARAMETERS srt=7; desc=DESC ??!srt&!s_curr=s_curr
$SET_PARAMETERS srt=7  ??srt>9&!s_curr=s_curr
$SET_PARAMETERS srn=1; rpp=100  ??!rpp
$SET_PARAMETERS dsumm=1 ??!dsumm
$SET_PARAMETERS f_stat=; ??f_stat_all=all_ZZZZZZ
$SET_PARAMETERS payed=; ??f_dog|f_platNr

<form name="theForm" method="POST" enctype="multipart/form-data">
<input type=hidden name="c" value="#c#">
<input type=hidden name="srn" value="#srn#">
<input type=hidden name="desc" value="#desc#">
<input type=hidden name="noTable" value="">

<table border=0 cellpadding=0 cellspacing=0 style="margin:20px; width:98%"><tr><td width=90%>
<h3>1C - Сведения о платежах</td><td align=right nowrap=true></td><td align=right nowrap=true>
<a class=info href="#ServerPath#/adb/adb">Главная</a></td></tr></table>

<table border=0 style="margin:0; margin-left:100px;"><tr><td nowrap=true valign=top bgcolor=white> 
<FIELDSET><LEGEND><b><i>Отобрать записи:</i></b></LEGEND>
<table bgcolor=##E8F0F8><tr><td valign=top>
<table border=0 cellpadding=1>

 <tr><td align=right>Подразделение:</td><td>
<select class=s1 name="f_lab"><option value="">ВСЕ
<option value="#lab_codes#">Все лаборатории
<option value="032">УНЦ
<option value="090">ОРРИ
<option value="100">ЛФВЭ
<option value="200">ЛЯП
<option value="300">ЛТФ
<option value="400">ЛНФ
<option value="500">ЛЯР
<option value="600">ЛИТ
<option value="700">ЛФЧ 
<option value="#infr_codes#">Инфраструктура ОИЯИ 
<option value="919">ЦБ ОМТС
<option value="011">ОКС

<option value="XXX">Другое
<option value="000">Не указано
<option value="NULL">Пусто
</select>
Тема: <input class=xp size=5 name="f_subject" value='#f_subject#'>
</td><td rowspan=7 valign=top>
$INCLUDE [f_curr]
</td>
<td rowspan=5 valign=top> ??
$INCLUDE [f_incomplete] ??
</td> ??
</tr>

<tr><td align=right nowrap=true>Контрагент:</td><td> <input class=xp size=40 name="f_contrag" value='#f_contrag#'>
&nbsp; (* - любые символы) ??
</td></tr>
<tr><td align=right nowrap=true>Договор:</td><td> <input class=xp size=30 name="f_dog" value='#f_dog#'>
&nbsp; (* - любые символы) ??
</td></tr>
<tr><td align=right nowrap=true>Счет контрагента:</td><td> <input class=xp size=30 name="f_schet_k" value='#f_schet_k#'>
&nbsp; (* - любые символы) ??
</td></tr>
<tr><td align=right nowrap=true>XXX:</td><td><select class=s1 name="f_vidoper"><option value="">ВСЕ#OPER_LIST#</select></td></tr> ??
<tr><td align=right valign=top nowrap=true>Статья движения<br>денежных средств:</td><td valign=top align=right><select class=s1 name="f_statia"><option value="">ВСЕ#STATIA_LIST#</select><br><i><a id="a_showStat" href="javascript:showStat()">
расширенный выбор >> ??!f_stat
простой выбор <<  ??f_stat
</a></i>&nbsp;&nbsp;&nbsp;</td></tr>

<tr><td align=right nowrap=true>№ платежки: </td><td colspan=1><input class=xp size=6 name="f_platNr" value='#f_platNr#'>
ID doc: <input class=xp size=10 name="iddoc" value='#iddoc#'>  ??XXXuname=serg

Сумма:
<select name=f_summa_op onChange="setDsumm()"><option>=<option>&gt;<option>&lt;</select>
<input class=xp size=8 name="f_summa" value='#f_summa#'> руб.
<span id=s_dsumm style="display:inline"><b>+- </b><input class=xp size=1 name="dsumm" value='#dsumm#'></span>
</td></tr>

<tr><td nowrap=true align=right>
Дата оплаты:</td><td nowrap=true colspan=1>
$INCLUDE common.dat[dat] param: fd_name=startdate; fd_val=#startdate#; yr1=-4; yr2=1; class=xp;
&nbsp;&nbsp;[по: 
$INCLUDE common.dat[dat] param: fd_name=enddate; fd_val=#enddate#; yr1=-4; yr2=1; class=xp;
]&nbsp; &nbsp;
</td></tr>

<tr><td></td><td valign=top><input type=radio name=payed value="1"
checked ??payed=1|form=y
>Только оплаченные
<input type=radio name=payed value="0"
checked ??payed=0
>Только не оплаченные
<input type=radio name=payed value=""
checked ??!payed&!form=y
>Все
</td></tr>

<TR>
<td align=right nowrap=true></td>
<td valign=top>
<input type=checkbox name="nonreg"
checked ??nonreg
>Только незарегистрированные
<input type=checkbox name="f_bud"
checked ??f_bud
>Исключить "внеб"
</td>
<td><input type="submit" value="Выполнить" onClick="return doIt();"><br>&nbsp;
</td></tr></table>

</td><td><div id=d_f_stat 
style="display:none;" ??!f_stat
><FIELDSET><LEGEND><b><i>Статья:</i></b></LEGEND><small>
<input type=checkbox name="f_stat_all" value="all" onClick="setCbStatia(this)" ??
checked ??ZZZf_stat_all=all !f_stat
>ВСЕ<br> ??
#STATIA_CBLIST#</small></FIELDSET>

</td></tr></table>
</FIELDSET>
</td></tr></table>

$INCLUDE [script]  
<center> 
$INCLUDE [totalTable] ??!form=y
</center> 

<table bgcolor=808080 border=0 cellspacing=0 cellpadding=0 style="margin:10px;" width_=98%><tr><td>
[end]

[totalTable]
<table style="border: solid 1px red; background-color:white;">
<tr><td align=right><b>Всего записей:</b></td><td><b>#NUM_RECS#</b></td></tr>
<tr><td align=right><b>Сумма по счетам:</b></td><td><b>#SCHET_SUMM_RUB# руб.</b></td></tr>
<tr><td><b>Сумма по платежкам:</b></td><td><b>#PLAT_SUMM_RUB# руб.</b></td></tr>
</table>
SCHET_SUMM_VAL=#SCHET_SUM_VAL# SCHET_SUMM_RUB=<br> PLAT_SUMM_VAL=#PLAT_SUMM_VAL# PLAT_SUMM_RUB=#PLAT_SUMM_RUB# ??
[end]

[f_curr]
<FIELDSET><LEGEND><b><i>Валюта операции:</i></b></LEGEND>
<input type="radio" name="f_curr" value="" 
checked ??!f_curr
> любая&nbsp;<br><input type="radio" name="f_curr" value="руб." 
checked ??f_curr=руб.
> рубли&nbsp;<br><input type="radio" name="f_curr" value="EUR" 
checked ??f_curr=EUR
> EUR<br><input type="radio" name="f_curr" value="USD" 
checked ??f_curr=USD
> USD<br><input type="radio" name="f_curr" value="other" 
checked ??f_curr=other
> другая</FIELDSET>

<FIELDSET><LEGEND><b><i>Показать:</i></b></LEGEND>
<input type="radio" name="s_curr" value="" 
checked ??!s_curr
> только рубли&nbsp;<br><input type="radio" name="s_curr" value="s_curr" 
checked ??s_curr=s_curr
> рубли и валюту</FIELDSET>
[end]

[f_incomplete]
<FIELDSET><LEGEND><b><i>Отобрать:</i></b></LEGEND>
<input type="radio" name="f_incomplete" value="" 
checked ??!f_incomplete
>все&nbsp;<br><input type="radio" name="f_incomplete" value="s_all" 
checked ??f_incomplete=s_all
>со счетом и с платежкой<br><input type="radio" name="f_incomplete" value="s_schet" 
checked ??f_incomplete=s_schet
>только со счетом<br><input type="radio" name="f_incomplete" value="s_plat" 
checked ??f_incomplete=s_plat
>только с платежкой<br><input type="radio" name="f_incomplete" value="s_either" 
checked ??f_incomplete=s_either
>со счетом или с платежкой
</FIELDSET>
[end]


[report footer]
$INCLUDE common.dat[rpp] ??!NumTableRows=0
<input type=hidden name="rpp" value="#rpp#"> ??NumTableRows=0|node_id=0
</TD></TR></TABLE>  
</form></center>
srt=#srt# ??
</body></HTML>
[end]

[script]
<script> 
var frm=document.theForm;
window.focus();
selectOptionByVal(frm.f_lab,'#f_lab#')  ??f_lab
selectOptionByVal(frm.f_lab,'#A_LABS#')  ??A_LABS
selectOptionByVal(frm.f_summa_op,'#f_summa_op#')  ??f_summa_op
selectOptionByVal(frm.f_statia,'#f_statia#')  ??f_statia&!f_stat

function showContr(contr)
{ frm.f_contrag.value = contr;
	frm.submit();
}

function showStat()
{ 
	var d = document.getElementById("d_f_stat");
	var a = document.getElementById("a_showStat");
	if (d.style.display=="none")
	{
		d.style.display="block";
		selectOptionByVal(frm.f_statia,'')
		a.innerHTML="простой выбор << ";
		setCbStatiaChecked(true); ??
	}
	else
	{
		d.style.display="none"; 
		a.innerHTML="расширенный выбор >> ";
		setCbStatiaChecked(false);
	}
	setCbStatia(frm.f_stat_all); ??
	frm.f_stat_all.checked=true; ??
}

function setCbStatiaChecked(checked)
{ 
  for (i=0; i<frm.f_stat.length; i++)
		frm.f_stat[i].checked=checked;
}

function setCbStatia(cb)
{ 
  for (i=0; i<frm.f_stat.length; i++)
		frm.f_stat[i].disabled=cb.checked;
}

function setDsumm()
{ if (frm.f_summa_op.options.selectedIndex == 0)
    document.getElementById("s_dsumm").style.display="inline";
  else 
    document.getElementById("s_dsumm").style.display="none";
}
setDsumm();

function showAdb2(num)
{  openWindow("c=doc/docEdit&DOC_ID=" + num,"adb2doc",930,670);
}


function goToRow(nr)
{ if (!checkFields()) return false;
  frm.srn.value=nr;  
//  alert (frm.srn.value);
  frm.submit();
  return true; 
}

function doIt()
{ if (!checkFields()) return false;
  frm.srn.value="1";
//  alert ("here!");
  frm.submit();  
  return true;
}

function checkFields()
{ 
  if (!checkFloat("f_summa",null,null,"Сумма")) return false;   
  return true;
}

function showPlat(nr)
{
	openWindow("c=c1/plat2&DOCNO=" + nr, "plat", 800,650);
}
function showAll(id)
{
	openWindow("c=c1/showRecord&id=" + id, "rec", 800,650);
}

</script> 
[end]



================================ SQLs ================================
select upper(replace('#f_contrag_#','*','%')) as "f_contrag" from dual; ??f_contrag_
select upper(replace('#f_dog_#','*','%')) as "f_dog" from dual; ??f_dog_

[preSQLs]
select to_char(SYSDATE, 'dd.mm.yyyy') as TODAY from dual; ??
$INCLUDE [getTotals] ??!form=y
select distinct '<option value="'||nvl(STATIA,'NULL')||'">'||nvl(STATIA,'не указана') as "STATIA_LIST"
, '<input type=checkbox name=f_stat value="'||nvl(STATIA,'NULL')||'"'
 ||case when '#f_stat#' like '%'||nvl(STATIA,'NULL')||'%' then ' checked' 
 else '' end
 ||' disabled' ??ZZZ&f_stat_all=all|!f_stat
 ||'>'||nvl(STATIA,'не указана')||'<br>' as "STATIA_CBLIST"
FROM C1_PLATLIST2 p
;
[end]

[getTotals]
select 
count(COUNTKEY) as "NUM_RECS"
, to_char(sum(SCHET_SUMM_RUB),'999G999G999G999') as "SCHET_SUMM_RUB"
, to_char(sum(PLAT_SUMM_RUB),'999G999G999G999') as "PLAT_SUMM_RUB"
FROM C1_PLATLIST2 p
left join I_LAB l on l.code=p.DIVCODE
$INCLUDE [criteria]
;
[end]

YEAR COUNTKEY

[SQL]
SELECT 
''''||COUNTKEY, ??
 '<a href="javascript:showContr('''||CONTRAGENT||''')">'||CONTRAGENT||'</a>' as "CONTRAGENT"
, DOGOVOR 
, case when not EXT_DOC_DATE is null then EXT_DOC_NR ||' от '|| EXT_DOC_DATE else '' end as "SCHET"
, decode(SCHET_SUMM_VAL,0,'',SCHET_SUMM_VAL) as "SCHET_SUM", SCHET_VAL  ??s_curr=s_curr
, 
 '<a href="javascript:showAll('||COUNTKEY||')">--'
 ||SCHET_SUMM_RUB
 ||'--</a>' as
SCHET_SUMM_RUB 
, STATIA ??
,nvl(l.div, ''''||p.DIV) 
 ||' /'||DIVCODE ??USER_ID=1
as "DIV"
,''''||SUBJECT as "SUBJECT"

,case when PLAT_NR>0 then 
 decode(payed, 1, '<img src="#imgPath#checked_ok.gif" width=12 height=15 alt="Оплачено">', '<img src="#imgPath#yellow2.gif" width=12 height=12 alt="НЕ Оплачено">')
 ||'<a href="javascript:showPlat('||PLAT_NR||')"><small>'||PLAT_NR||'&nbsp;от&nbsp;'||PLAT_DATE||'</small></a>'
 

 else '' end as "PLAT"
,decode(PLAT_SUMM_VAL,0,' ',PLAT_SUMM_VAL) "SUM", PLAT_VAL   ??s_curr=s_curr
,PLAT_SUMM_RUB 
, decode(nvl(ADB2_NUM,0), 0, '<center>-</center>', '<center><a href="javascript:showAdb2('||ADB2_NUM||')"><small>'||ADB2_NUM||'</small></a></center>') as "ADB2"
, EXT_DOC ,EXT_DOC_DATE ??

FROM C1_PLATLIST2 p
left join I_LAB l on l.code=p.DIVCODE
$INCLUDE [criteria]
ORDER BY 
$INCLUDE [order fields rub] ??!s_curr=s_curr
$INCLUDE [order fields curr] ??s_curr=s_curr
#srt# #desc# 
[end]

[order fields rub]
EXT_DOC_DATE #desc#, ??srt=3
nvl(PLAT_DATE,to_date('2010-01-01','YYYY-MM-DD')) #desc#,  ??srt=7
[end]
PLAT_NR #desc#,  ??srt=6


[order fields curr]
EXT_DOC_DATE #desc#, ??srt=3
PLAT_DATE #desc#,  ??srt=9
[end]


[criteria]
WHERE 
1=1
and payed=#payed# ??payed
and DIVCODE IN()'#A_LABS#' ??A_LABS
and DIVCODE in(#f_lab#)  ??f_lab&!f_lab=XXX&!f_lab=NULL
and not DIVCODE in(000, #lab_codes#, #infr_codes#, 919, 011)  ??f_lab=XXX
and DIVCODE is null  ??f_lab=NULL
and (SCHET_VAL='#f_curr#' or PLAT_VAL='#f_curr#') ??f_curr&!f_curr=other
and (not SCHET_VAL in('руб.','USD','EUR') or not PLAT_VAL in('руб.','USD','EUR'))??f_curr=other
and upper(CONTRAGENT) like upper('%#f_contrag#%') ??f_contrag

and upper(DOGOVOR) like '%#f_dog#%'	??f_dog
and upper(EXT_DOC_NR) like '%#f_schet_k#%'	??f_schet_k
and upper(SUBJECT)=upper('#f_subject#')  ??f_subject
and PLAT_SUMM_RUB #f_summa_op# #f_summa# ??f_summa&!f_summa_op==
and abs(PLAT_SUMM_RUB-#f_summa#) <= #dsumm#+0.5 ??f_summa&f_summa_op==
and STATIA='#f_statia#' ??f_statia&!f_stat&!f_statia=NULL
and STATIA is null ??!f_stat&f_statia=NULL
and '#f_stat#' like '%'||nvl(STATIA,'NULL')||'%' ??f_stat&!f_stat_all=all
and PLAT_NR=#f_platNr# ??f_platNr

$INCLUDE [yearCriteria]  ??!startdate&!enddate
	and PLAT_DATE >= to_date('#startdate#','DD.MM.YYYY') ??startdate&!enddate
	and PLAT_DATE between to_date('#startdate#','DD.MM.YYYY') and to_date('#enddate#','DD.MM.YYYY') ??startdate&enddate
	and PLAT_DATE <= to_date('#enddate#','DD.MM.YYYY') ??enddate&!startdate
and not EXT_DOC_DATE is null ??srt={{2|3|5}}
and (ADB2_NUM=0 or ADB2_NUM is null) ??nonreg
and (SUBJECT is null)  ??f_budZZZ
and (SUBJECT is null or (not SUBJECT like '%внеб%' and not SUBJECT like '%РФФИ%'))  ??f_bud
[end]
and (SUBJECT is null)  ??!f_bud

and (SUBJECT is null or (not SUBJECT like '%внеб%' and not SUBJECT like '%РФФИ%'))  ??f_bud


[yearCriteria]
and (PLAT_DATE between to_date('01.01.20#q_yr#','DD.MM.YYYY') and to_date('31.12.20#q_yr#','DD.MM.YYYY')
 or EXT_DOC_DATE between to_date('01.01.20#q_yr#','DD.MM.YYYY') and to_date('31.12.20#q_yr#','DD.MM.YYYY')
)
[end]

PLAT_NR>0 and 

and (PLAT_NR>0 and EXT_DOC_DATE is null) ??f_incomplete=s_plat
and (PLAT_NR>0 and (not EXT_DOC_DATE is null)) ??f_incomplete=s_all
and ((PLAT is null or length(PLAT)<1) and length(SCHET)>1) ??f_incomplete=s_schet
and (length(PLAT)>1 and (SCHET is null or length(SCHET)<1) or ((PLAT is null or length(PLAT)<1) and length(SCHET)>1)) ??f_incomplete=s_either

PLAT <> null and SCHET<>null and 

[colNames]
SUBJECT=Тема
CONTRAGENT=Контрагент
DOGOVOR=Договор
SCHET=Счет<br>контрагента
SCHET_SUM=Сумма&nbsp;счета<br>в валюте
 <br>#f_curr# ??!f_curr=other
SCHET_SUM=Сумма счета ??f_curr=otherXXX
SCHET_SUMM_RUB=Сумма&nbsp;счета<br>руб.
PLAT=Платежное<br>поручение
DIV=Подразд.
SUM=Сумма<br>в&nbsp;валюте
PLAT_SUMM_RUB=Сумма<br>руб.
PLAT_VAL=Валюта<br>п/п
SCHET_VAL=Валюта<br>счета
VID_OPER=Вид операции
STATIA=Статья движения<br>денежных средств
ADB2=ADB2<br>документ
[end]


, case when SCHET_VAL='руб.' then to_char(SCHET_SUMM_RUB,'999999999D00')
else to_char(SCHET_SUMM_VAL ,'999999999D00')
end  as "SCHET_SUM" 

, case when PLAT_VAL='руб.' then to_char(PLAT_SUMM_RUB,'999999999D00')
else to_char(PLAT_SUMM_VAL ,'999999999D00')
end
as "SUM"

