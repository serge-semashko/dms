[parameters]
service=dubna.walt.service.TableServiceSimple ??M_1C_PROV>0&piv=Y
service=dubna.walt.service.CrossTabService  ??M_1C_PROV>0&!form=y&!piv=Y
service=dubna.walt.service.CrossTabSubtotService ??
title=1С-Сводная таблица проводок

debug=on ??

makeTotalsForCols=S,N
makeSubtotals=y ??
totRowLabel=Всего

tableCfg=table.cfg 
thsnDelimiter=&nbsp;
numDigits=2
NumSpecialCols=0

table_beg=<table border="1" cellspacing="1" cellpadding="2"> ??
wrapperTable=none
wrapperTableEnd=none
$INCLUDE common.dat[colors]
[end]


[report]
$SET_PARAMETERS f_acc=20; f1=acc; f2=lab; f3=sbj; piv=Y;
$INCLUDE [logged report header] ??M_1C_PROV>0
</td></tr></table>
</td></tr></table>
</form></center>
</body></HTML>
[end]


[report header]
$INCLUDE [logged report header]   ??M_1C_PROV>0&logged|det=y
<script>window.location.href="#loginURL#?back_url=#ServerPath##ServletPath#";</script> ??!logged&!det=y
[end]


[logged report header]
$INCLUDE common.dat[head]
<body bgcolor=F4FFFA>
<style> fieldset {border:solid 1px ##a0a0a0;} .control {cursor:pointer;}</style> 
$SET_PARAMETERS s_acck=on ??form=y
$SET_PARAMETERS srn=1; rpp=100 ??!srn|!rpp
$SET_PARAMETERS srt=1 ??!srt
$SET_PARAMETERS f2=; ??f2=#f1#
$SET_PARAMETERS f3=; ??f3=#f1#|f3=#f2#
$SET_PARAMETERS f4=; ??f4=#f1#|f4=#f2#|f4=#f3#
$SET_PARAMETERS f5=; ??f5=#f1#|f5=#f2#|f5=#f3#|f5=#f4#
$SET_PARAMETERS bud=Y ??f1=bud|f2=bud|f3=bud|f4=bud|f5=bud

<center>

<form name="theForm" method="POST" enctype="multipart/form-data">
<input type=hidden name="c" value="#c#">
<input type=hidden name="srn" value="0">
<input type=hidden name="rpp" value="9999">
<input type=hidden name="desc" value="#desc#">
<input type=hidden name="noTable" value="">

<table border=0 cellpadding=0 cellspacing=0 style="margin:20px; width:98%"><tr><td width=90%>
<h3>1C - Проводки - сводная таблица, 20#q_yr# год</td><td align=right nowrap=true></td><td align=right nowrap=true>
<a class=info href="/adb/adb">Главная</a></td></tr></table>

<table border=0  bgcolor=##E8F0F8 style="border:solid 1px black;">

<tr><td nowrap=true colspan=2 valign=top>
<FIELDSET><LEGEND><b><i>Отобрать:</i></b></LEGEND>
<table border=0>

<tr><td align=right>Счет:</td><td><input class=xpc size=15 name="f_acc" value='#f_acc#'></td>
<td colspan=4><a href="javascript:showDiv('skdet')">Для сч.20,23,25,26(*):</a></td>
</tr>
<tr><td align=right>Субконто 1:</td><td><input class=xpc size=20 name="f_acc_1" value='#f_acc_1#'></td>
<td align=right>подразд.:</td><td><input class=xpc size=7 name="f_lab" value='#f_lab#'></td>
<td align=right>тип: <SELECT NAME="opt2"><OPTION VALUE=""> Все <OPTION VALUE="pr"
SELECTED	??opt2=pr
> Производств.<OPTION VALUE="labs" 
SELECTED	??opt2=labs
> Лаборатории</SELECT>
</tr>

<tr><td align=right>Субконто 2:</td><td><input class=xpc size=20 name="f_acc_2" value='#f_acc_2#'></td>
<td align=right> тема (дог.,уст.,):</td><td><input class=xpc size=7 name="f_sbj" value='#f_sbj#'></td>
<td align=right>выбрать: <SELECT NAME="sk2type"><OPTION VALUE=""> Все 
<OPTION VALUE="Тема"> Темы
<OPTION VALUE="Дог."> Договоры
<OPTION VALUE="Уст."> Установки
</SELECT>
</td></tr>

<tr><td class=t align=right>Субконто 3:</td><td class=t><input class=xpc size=20 name="f_acc_3" value='#f_acc_3#'>
</td><td align=right> субстатья:</td><td colspan=2><input class=xpc size=7 name="f_sst" value='#f_sst#'>
<input type=checkbox name=close
checked ??close
>закрытие
</td></tr>

<tr><td class=t colspan=2>
<small><a href="javascript:showDiv('skdet')"><i>(*) справка по субконто>></i></small>
</td><td>статья бюджета:</td><td><input class=xpc size=2 name="f_bud" value='#f_bud#'>
</td></tr>

<tr><td colspan=5>
<div id="skdet" style="padding:0 0 0 40px; display:none;">
<table border=0>
<tr><td>Счет</td><td>СК-1</td><td>СК-2</td><td>СК-3</td></tr>
<tr><td>20.xx, 23.хх:</td><td> подразделение</td><td> тема(договор)</td><td> субстатья</td></tr>
<tr><td>25.хх:</td><td> подразделение</td><td> субстатья</td><td> установка</td></tr>
<tr><td>26.01:</td><td> подразделение</td><td> субстатья</td><td> -</td></tr>
<tr><td colspan=4><small>для других счетов субконто не анализируются!</small></td></tr>
</table></div>
</td></tr>

<tr><td align=right>Содержание:</td><td colspan=3><input class=xp size=40 name="f_soder" value='#f_soder#'></td></tr>
<tr><td align=right>Комментарий:</td><td colspan=3><input class=xp size=40 name="f_comments" value='#f_comments#'></td></tr>

<tr><td align=right>Кто провел:</td><td colspan=3>
<select name=f_creator ><option value="">все</option><option value="-">пусто</option>
#CREATOR_LIST#</select>
</td></tr>
<tr><td align=right>Регистр:</td><td><input class=xpc size=8 name="f_reg" value='#f_reg#'></td>

<td nowrap=true align=right colspan=3>Период:
<SELECT NAME="tp" ONCHANGE="setTPE();">
<OPTION VALUE=""> весь год
<OPTION VALUE="" > ------------
<OPTION VALUE="1" > I квартал
<OPTION VALUE="2" > II квартал
<OPTION VALUE="3" > III квартал
<OPTION VALUE="4" > IV квартал
<OPTION VALUE="6" > 1-е полуг.
<OPTION VALUE="26" > 2-е полуг.
<OPTION VALUE="9" > 9 месяцев
<OPTION VALUE="" > ------------
<OPTION VALUE="0"> мм
<OPTION VALUE="mm-mm"> мм-мм ??
</SELECT>
<INPUT TYPE="text" SIZE=3 NAME="tpe" VALUE="#tpe#" class=xpc ONCHANGE="setTP();">
</td>

</tr>
</table>
</FIELDSET></td>

<td valign=top>
<FIELDSET><LEGEND><b><i>Показать:</i></b></LEGEND>
<table border=1 bgcolor=##E8F0F8> ??

поле 1: <SELECT NAME="f1" >
$INCLUDE [fields]
</SELECT>

<br>поле 2: <SELECT NAME="f2" ><OPTION VALUE="">-
$INCLUDE [fields]
</SELECT><IMG SRC="#imgPath#arrow-double-2.gif" class=control HEIGHT=28 WIDTH=12 onClick="swap(1);">

<br>поле 3: <SELECT NAME="f3" ><OPTION VALUE="">-
$INCLUDE [fields]
</SELECT>
<IMG SRC="#imgPath#arrow-double-2.gif" class=control HEIGHT=28 WIDTH=12 onClick="swap(2);">

<br>поле 4: <SELECT NAME="f4" ><OPTION VALUE="">-
$INCLUDE [fields]
</SELECT>
<IMG SRC="#imgPath#arrow-double-2.gif" class=control HEIGHT=28 WIDTH=12 onClick="swap(3);">

<br>поле 5: <SELECT NAME="f5" ><OPTION VALUE="">-
$INCLUDE [fields]
</SELECT>
<IMG SRC="#imgPath#arrow-double-2.gif" class=control HEIGHT=28 WIDTH=12 onClick="swap(4);">

<br><br>
<B>Вид таблицы:</B>
<INPUT TYPE="radio" NAME="piv" VALUE="Y"
CHECKED ??piv=Y
><IMG ALIGN="CENTER" VALIGN="TOP" SRC="#imgPath#YYY.gif" BORDER=0 ALT="Таблица с тремя полями вниз" HEIGHT=32 WIDTH=32>

<INPUT TYPE="radio" NAME="piv" VALUE="X" 
CHECKED ??!piv=Y
><IMG ALIGN="CENTER" VALIGN="TOP" SRC="#imgPath#YYX.gif" BORDER=0 ALT="Два поля вниз и одно - вправо" HEIGHT=32 WIDTH=32>

</fieldset>

<TR><td align=right colspan=2> ??
<br>&nbsp;<input type="submit" value="Выполнить">&nbsp;<br>&nbsp;
</td></tr> ??
</tr></table>

$INCLUDE [script]  

<table bgcolor=808080 border=0 cellspacing=0 cellpadding=0 style="margin:10px;" ><tr><td> 
[end]

[fields]
<OPTION VALUE="acc"> Счет
<OPTION VALUE="acc_1"> Субконто 1
<OPTION VALUE="lab"> Подразделение
<OPTION VALUE="acc_2"> Субконто 2
<OPTION VALUE="sbj"> Тема(или дог., грант, уст.)
<OPTION VALUE="acc_3"> Субконто 3
<OPTION VALUE="sst"> Субстатья
<OPTION VALUE="bud"> Бюдж. статья
<OPTION VALUE="st"> Статья ??
<OPTION VALUE="typ"> Тип (д/к)
<OPTION VALUE="sod"> Содержание
<OPTION VALUE="comm"> Комментарий

<OPTION VALUE="reg"> Регистр
<OPTION VALUE="cre"> Кто провел
<OPTION VALUE="qua"> Квартал 
<OPTION VALUE="mm"> Месяц
<OPTION VALUE="dat"> Дата
[end]

[report footer]
</TD></TR></TABLE>  
</form></center>
</body></HTML>
[end]

[script]
<script> 
var frm=document.theForm;
window.focus();
selectOptionByVal(frm.f_creator,'#f_creator#')  ??f_creator
selectOptionByVal(frm.f_summa_op,'#f_summa_op#')  ??f_summa_op
selectOptionByVal(frm.f1,'#f1#')  ??f1
selectOptionByVal(frm.f2,'#f2#')  ??f2
selectOptionByVal(frm.f3,'#f3#')  ??f3
selectOptionByVal(frm.f4,'#f4#')  ??f4
selectOptionByVal(frm.f5,'#f5#')  ??f5
selectOptionByVal(frm.tp,'#tp#')  ??tp
selectOptionByVal(frm.sk2type,'#sk2type#')  ??sk2type


function showDiv(div)
{ var d = document.getElementById(div);
	if (d.style.display=="none")
	d.style.display="block"
	else
	d.style.display="none";
}


function swap(nr)
{
	var s1 = eval("document.theForm.f" + nr);
	var n = nr + 1;
	var s2 = eval("document.theForm.f" + n);
	v1 = getSelectedVal(s1);
	selectOptionByVal(s1, getSelectedVal(s2));
	selectOptionByVal(s2, v1);
}

function setTPE()
{
if (frm.tp.options.selectedIndex < 10)
frm.tpe.value = "";
}
function setTP()
{
if (frm.tpe.value.length <1)
frm.tp.options.selectedIndex = 0;
else if (frm.tpe.value.length <3)
frm.tp.options.selectedIndex = 10;
else
frm.tp.options.selectedIndex = 11;
}
</script> 
[end]



================================ SQLs ================================

[preSQLs]
select distinct 
''''||CREATOR||''''||CREATOR as "CREATOR_LIST" ??
'<option value="'||CREATOR||'">'||CREATOR as "CREATOR_LIST" 
from C1_PROVODKI
where not CREATOR is null 
order by 1
;
select instr('#f_acc#',',') as "ACC_LIST" from dual ??f_acc

[end]


[SQL_Cross_Values]
SELECT distinct 
$INCLUDE [f] param: key=#f1#; comma=N ??!f2&!f3&!f4&!f5
$INCLUDE [f] param: key=#f2#; comma=N ??f2&!f3&!f4&!f5
$INCLUDE [f] param: key=#f3#; comma=N ??f3&!f4&!f5
$INCLUDE [f] param: key=#f4#; comma=N ??f4&!f5
$INCLUDE [f] param: key=#f5#; comma=N ??f5
FROM C1_OPER p
left join I_ACC1_#q_yr# a on a.code=p.sst ??f_bud|bud=Y
$INCLUDE [criteria]
order by 
$INCLUDE [f] param: key=#f1#; comma=N ??!f2&!f3&!f4&!f5
$INCLUDE [f] param: key=#f2#; comma=N ??f2&!f3&!f4&!f5
$INCLUDE [f] param: key=#f3#; comma=N ??f3&!f4&!f5
$INCLUDE [f] param: key=#f4#; comma=N ??f4&!f5
$INCLUDE [f] param: key=#f5#; comma=N ??f5
[end]


[numDigitsForCols]
S=2
N=0
[end]


[SQL]
SELECT 
$INCLUDE [ff]
,count(id) as "N"  ??piv=Y
 ,sum(s) as "S"
FROM C1_OPER p 
left join I_ACC1_#q_yr# a on a.code=p.sst ??f_bud|bud=Y
$INCLUDE [criteria]
group by 
$INCLUDE [ff]
order by 
$INCLUDE [ff]
[end]

[ff]
$INCLUDE [f] param: key=#f1#; comma=N
$INCLUDE [f] param: key=#f2#; ??f2
$INCLUDE [f] param: key=#f3#; ??f3
$INCLUDE [f] param: key=#f4#; ??f4
$INCLUDE [f] param: key=#f5#; ??f5
[end]

[f] param: key=f1; comma=Y
, ??comma=Y
''''||acc ??key=acc
''''||acc_1  ??key=acc_1
''''||acc_2  ??key=acc_2
''''||acc_3  ??key=acc_3
''''||lab 	 ??key=lab
''''||sbj 	??key=sbj
''''||sst 	??key=sst
''''||aggr1  ??key=bud
soder ??key=sod
comments ??key=comm
''''||nvl(reg,'-') ??key=reg
creator ??key=cre
''''||quart 		??key=qua
''''||mm 		??key=mm
TYP 		??key=typ
to_char(dat,'DD.YY.YYYY HH:MI')		??key=dat
[end]

[criteria]
WHERE 
1=1
and p.ACC like '#f_acc#%' ??f_acc&ACC_LIST=0
and p.ACC IN()'#f_acc#' ??f_acc&ACC_LIST>0
and upper(p.ACC_1) like upper('#f_acc_1#%') ??f_acc_1&!f_acc_1=-
and p.ACC_1 is null ??f_acc_1=-
and upper(p.ACC_2) like upper('#f_acc_2#%') ??f_acc_2&!f_acc_2=-
and p.ACC_2 is null ??f_acc_2=-
and upper(p.ACC_3) like upper('#f_acc_3#%') ??f_acc_3&!f_acc_3=-
and p.ACC_3 is null ??f_acc_3=-
and p.lab IN()'#f_lab#' ??f_lab&!f_lab=-
and p.lab is null ??f_lab=-
and p.lab 	??opt2
not	??opt2=pr
in('032','090','100','200','300','400','500','600','700') ??opt2
and p.sbj IN()'#f_sbj#'??f_sbj&!f_sbj=-
and p.sbj is null ??f_sbj=-
and p.sbj='#f_sbj#' and type='Тема' ??f_sbj_ZZZ
and p.sbj='#f_dog#' and type='Дог.' ??f_dog_ZZZ
and p.sst IN()'#f_sst#' ??f_sst&!f_sst=-
and p.sst is null ??f_sst=-
and (p.sst is null or p.sst not in('120','121'))	??!close
and p.type='#sk2type#' ??sk2type
and a.AGGR1='#f_bud#' ??f_bud&!f_bud=-
and a.AGGR1 like '%-%' ??f_bud=-
and upper(p.soder) like upper('%#f_soder#%') ??f_soder
and upper(p.comments) like upper('%#f_comments#%') ??f_comments
and upper(p.REG) like upper('%#f_reg#%') ??f_reg&!f_reg=-
and p.REG is null ??f_reg=-
and p.creator='#f_creator#' ??f_creator&!f_creator=-
and p.creator is null ??f_creator=-
and p.YEAR=20#q_yr#
and p.mm=#tpe# ??tpe&tp=0
and p.quart=#tp# ??tp>0&tp<5
and p.quart in(1,2) ??tp=6
and p.quart in(3,4) ??tp=26
and p.quart<4 ??tp=9
[end]


[colNames]
||ACC=Счет
''''||ACC=Счет
||ACC_1=Субконто 1
''''||ACC_1=Субконто 1
||ACC_2=Субконто 2
''''||ACC_2=Субконто 2
||ACC_3=Субконто 3
''''||ACC_3=Субконто 3
||SST=Субстатья
''''||SST=Субстатья
||AGGR1=Бюдж.статья
''''||AGGR1=Бюдж.статья
||LAB=Подразд.
''''||LAB=Подразд.
 
||SBJ=Тема  ??!sk2type|sk2type=Тема
''''||SBJ=Тема  ??!sk2type|sk2type=Тема
||SBJ=Договор  ??sk2type=Дог.
''''||SBJ=Договор  ??sk2type=Дог.
||SBJ=Установка  ??sk2type=Уст.
''''||SBJ=Установка  ??sk2type=Уст.

S=Сумма
SODER=Содержание
COMMENTS=Комментарий
CREATOR=Провел
||NVL(REG,-)=Регистр
''''||NVL(REG,'-')=Регистр
TO_CHAR(DAT,DD.YY.YYYYHH:MI)=Дата
TO_CHAR(DAT,'DD.YY.YYYYHH:MI')=Дата
||MM=м-ц
''''||MM=м-ц
||QUART=к-л
''''||QUART=к-л
TYP=тип
N=кол-во
[end]

