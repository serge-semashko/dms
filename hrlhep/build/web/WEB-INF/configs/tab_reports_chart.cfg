tab_reports_chart.cfg

[comments]
descr=Графики сводных отчетов
input=none
output=HTML таблица объектов
parents=
author:Семашко С.
[end]

[parameters]
service=dubna.walt.service.TableServiceSpecial
request_name=U:Список документов
LOG=ON 
tableCfg=table_no
$INCLUDE dat/common.dat[rowLinks]
[end]

[report header]
    $INCLUDE [total table]   ??!XL=Y

    <div class=graphContaner id="otdelenie_chart"  style="margin-top:10px;color:black;border: solid 3px black">
    </div>
    <div class=graphContaner id="otdelenie_ppls_chart"  style="margin-top:10px;color:black;border: solid 3px black">
    </div>
    <div class=graphContaner id="age_pie_chart"  style="margin-top:10px;color:black;border: solid 3px black">
    </div>
    <div class=graphContaner id="age_chart"  style="margin-top:10px;color:black;border: solid 3px black">
    </div>
    <div class=graphContaner id="category_chart"  style="margin-top:10px;color:black;border: solid 3px black">
    </div>
    <table class="tlist tgreen" cellspacing=0 name="salary">
    <tr>
    <th class="srh" sr="sotr.tab_n">Таб.№</th>
    <th class="srh" sr="sotr.FIO">ФИО</th> 
    <th>Отделение</th>
    <th>Отдел</th> 
    <th class="srh" sr="sotr.post">Должность</th>
    <th class="srh" sr="sotr.category">Категория</th>
    <th class="srh" sr="oklad.oklad">Оклад</th>
    <th class="srh" sr="oklad.kompens">Компенсации</th> 
    <th class="srh" sr="oklad.dopl_stepen">Допл. за степень</th> 
    <th class="srh" sr="oklad.personal_nadbav">Персон. надбавки</th> 
    <th class="srh" sr="oklad.perconal_imen_nadbav">Персон.именная надбавка</th> 
    <th class="srh" sr="oklad.premija_rabochim">Премия рабочим</th> 
    <th class="srh" sr="oklad.sovmeshenie">Совмещение</th> 
    <th>Итого</th> 
    </tr>
[end]

[total table]
    $GET_DATA [get full]
    <table border=0 cellpadding=5 cellspacing=0>
    <tr><td class="label" > 
    $GET_DATA [get Totals] 
    Сумма по отделу:</td><td>#SUM_OTDEL#</td>
    <td class="label" > Сумма по отделению:</td> <td>#SUM_OTDELENIE#</td>
    <td class="label">Сумма по категории:</td><td>#SUM_CATEGORY#</td></tr> 
    </table><br> 
[end]

[item]
    ++++++++++++++++++ Строка таблицы - 1 документ +++++++++++++++++++++ ??
    <tr class="pt
    oddRow ??oddRow=1
    " 
    onClick="ShowDialog(true); AjaxCall('popupCont', 'c=edit/salary&tab_n=#tab_n#', true);" >
    <td>#tab_n#</td> 
    <td>#F# #I# #O#</td>
    <td>#topparent_name#</td>
    <td>#subtopparent_name#</td>
    <td>#post#</td>
    <td>#category#</td>
    <td>#oklad#</td>
    <td>#kompens#</td>
    <td>#dopl_stepen#</td>
    <td>#personal_nadbav#</td>
    <td>#perconal_imen_nadbav#</td>
    <td>#premija_rabochim#</td>
    <td>#sovmeshenie#</td>
    <td>#itogo#</td>
    </tr>
[end]

[report footer]
    $SET_PARAMETERS NumTableCols=14;
    $SET_PARAMETERS d_otdelenie=[#d_otdelenie#]
    $SET_PARAMETERS d_category=[#d_category#]
    $SET_PARAMETERS d_otdel=[#d_otdel#]
    $SET_PARAMETERS d_age=[#d_age#]
    $SET_PARAMETERS d_otdelenie_age_salary=[#d_otdelenie_age_salary#]
    $SET_PARAMETERS d_otdel_age_salary=[#d_otdel_age_salary#]
    
    <tr><td colspan=#NumTableCols# class="pager last">
    $INCLUDE dat/common.dat[rpp]  ??!NumTableRows=0
    <input type=hidden name="rpp" value="#rpp#"> ??NumTableRows=0
    </td></tr>
    </table>

    <script type="text/javascript">
        showSrt("#srt#","sup"); ??!desc
        showSrt("#srt#","sdown"); ??desc
    </script>

    <script type="text/javascript">
        console.log("create chart 1");
        var chart = AmCharts.makeChart("otdelenie_chart", {
    "titles": [

		{
			"id": "1",
                        text: "Распределение по ФОТ"
		}
	],

            "type": "pie",
            "theme": "light",
            "angle": 17.1,
            "dataProvider": #d_otdelenie#, ??!otdelenie
            "dataProvider": #d_otdel#, ??otdelenie
            "thousandsSeparator": " ",
            "valueField": "value",
            "titleField": "pname",
            "depth3D": 1,
            "innerRadius": 3,
            "radius": 164,
            "labelRadius": 4,
            "percentPrecision": 1,
            "precision": 0,
            "fontSize": 12,
            "labelText": "[[title]] \n [[percents]]%  ([[value]]т.р.)",
            "balloon": {
                "fixedPosition": true
            },
            "export": {
                "enabled": true
            }
        });

        var chart = AmCharts.makeChart("otdelenie_ppls_chart", {
    "titles": [

		{
			"id": "1",
                        text: "Распределение по сотрудникам"
		}
	],

            "type": "pie",
            "theme": "light",
            "angle": 17.1,
            "dataProvider": #d_otdelenie_age_salary#, ??!otdelenie
            "dataProvider": #d_otdel_age_salary#, ??otdelenie
            "thousandsSeparator": " ",
            "valueField": "v3",
            "titleField": "pname",
            "depth3D": 1,
            "innerRadius": 3,
            "radius": 164,
            "labelRadius": 4,
            "percentPrecision": 1,
            "precision": 0,
            "fontSize": 12,
            "labelText": "[[title]] \n [[percents]]%  ([[value]])",
            "balloon": {
                "fixedPosition": true
            },
            "export": {
                "enabled": true
            }
        });


    var chart = AmCharts.makeChart("age_pie_chart", {
    "titles": [

		{
			"id": "1",
                        text: "Распределение по возрастам"
		}
	],

        "type": "pie",
        "theme": "light",
        "dataProvider": #d_age#,
        "valueField": "cnt",
        "titleField": "pname",
	"depth3D": 10,
        "percentPrecision": 1,
	"precision": 0,
        "thousandsSeparator": " ",
	"innerRadius": 30,
	"labelRadius": 10,
        "labelText": "[[title]] лет: [[value]] ([[percents]]%)",
        "balloon": {
            "fixedPosition": true
        },
        "export": {
            "enabled": true
        }
    });

var chart = AmCharts.makeChart("age_chart", {
    "rotate": true,
    "type": "serial",
	"theme": "light",
    "legend": {
        "horizontalGap": 10,
        "maxColumns": 1,
        "position": "bottom",
		"useGraphSettings": true,
		"markerSize": 10
    },
    "dataProvider": #d_otdelenie_age_salary#, ??!otdelenie
    "dataProvider": #d_otdel_age_salary#, ??otdelenie

    "valueAxes": [
		{
			"id": "1",
			"title": ""
		}
        ],

    "graphs": [
     {
        "balloonText": "<b>[[title]]</b><br><span style='font-size:14px'>[[category]]: <b>[[value]]</b></span>",
        "fillAlphas": 0.8,
        "labelText": "[[value]]",
        "lineAlpha": 0.3,
        "title": "Средняя зарплата",
        "type": "column",
		"color": "#000000",
        "valueField": "v1"
    }, {
        "balloonText": "<b>[[title]]</b><br><span style='font-size:14px'>[[category]]: <b>[[value]]</b></span>",
        "fillAlphas": 0.8,
        "labelText": "[[value]]",
        "lineAlpha": 0.3,
        "title": "Средний возраст",
        "type": "column",
		"color": "#000000",
        "valueField": "v2"
    }, ],
    "categoryField": "pname",
    "categoryAxis": {
        "gridPosition": "start",
        "axisAlpha": 0,
        "gridAlpha": 0,
        "position": "left"
    },
    "export": {
    	"enabled": true
     }

});
debugger;
var chart = AmCharts.makeChart("category_chart", {
    "rotate": true,
    "type": "serial",
	"theme": "light",
    "legend": {
        "horizontalGap": 10,
        "maxColumns": 1,
        "position": "bottom",
		"useGraphSettings": true,
		"markerSize": 10
    },
    "dataProvider": #d_category#,
    "valueAxes": [
		{
			"id": "1",
			"title": ""
		}
        ],

    "graphs": [
     {
        "balloonText": "<b>[[title]]</b><br><span style='font-size:14px'>[[category]]: <b>[[value]]</b></span>",
        "fillAlphas": 0.8,
        "labelText": "[[value]]",
        "lineAlpha": 0.3,
        "title": "Средняя зарплата",
        "type": "column",
		"color": "#000000",
        "valueField": "v1"
    }, {
        "balloonText": "<b>[[title]]</b><br><span style='font-size:14px'>[[category]]: <b>[[value]]</b></span>",
        "fillAlphas": 0.8,
        "labelText": "[[value]]",
        "lineAlpha": 0.3,
        "title": "Средний возраст",
        "type": "column",
		"color": "#000000",
        "valueField": "v2"
    }, 
{
        "balloonText": "<b>[[title]]</b><br><span style='font-size:14px'>[[category]]: <b>[[value]]</b></span>",
        "fillAlphas": 0.8,
        "labelText": "[[value]]",
        "lineAlpha": 0.3,
        "title": "Сотрудников",
        "type": "column",
		"color": "#000000",
        "valueField": "v3"
    }, 
],
    "categoryField": "pname",
    "categoryAxis": {
        "gridPosition": "start",
        "axisAlpha": 0,
        "gridAlpha": 0,
        "position": "left"
    },
    "export": {
    	"enabled": true
     }

});


    </script>



[end]


[SQL]
    select sotr.topparent_name,sotr.subtopparent_name,sotr.person_id, sotr.tab_n, sotr.F, sotr.I, sotr.O, sotr.FIO, sotr.otdel
    , sotr.division, sotr.shtat_direct, sotr.post, sotr.category, oklad.year
    , oklad.oklad, oklad.kompens, oklad.dopl_stepen, oklad.personal_nadbav
    , oklad.perconal_imen_nadbav, oklad.premija_rabochim, oklad.sovmeshenie 
    , ifnull(oklad.oklad,0)+ifnull(oklad.kompens,0)+ifnull(oklad.dopl_stepen,0)
    +ifnull(oklad.personal_nadbav,0)+ifnull(oklad.perconal_imen_nadbav,0)
    +ifnull(oklad.premija_rabochim+oklad.sovmeshenie,0) as itogo
    from sotrudniki sotr
    left join oklad on sotr.tab_n=oklad.tab_n
    $INCLUDE utils.cfg[criteria] 
    order by #srt# #desc# ??srt

[end]
[get otdelenie]
[end]
[get full]
   select sum(ifnull(oklad.oklad,0)+ifnull(oklad.kompens,0)+ifnull(oklad.dopl_stepen,0)
    +ifnull(oklad.personal_nadbav,0)+ifnull(oklad.perconal_imen_nadbav,0)
    +ifnull(oklad.premija_rabochim+oklad.sovmeshenie,0)) as sum_otdelenie,
     sotr.TopParent_Name, count(sotr.TopParent_Name) as ppls,
    sum(ifnull(oklad.oklad,0)+ifnull(oklad.kompens,0)+ifnull(oklad.dopl_stepen,0)
    +ifnull(oklad.personal_nadbav,0)+ifnull(oklad.perconal_imen_nadbav,0)
    +ifnull(oklad.premija_rabochim+oklad.sovmeshenie,0))/count(sotr.TopParent_Name) as mean
    from sotrudniki sotr
    left join oklad on sotr.tab_n=oklad.tab_n
    where lab_id = 100000
    group by sotr.TopParent_Name;

   select sum(ifnull(oklad.oklad,0)+ifnull(oklad.kompens,0)+ifnull(oklad.dopl_stepen,0)
    +ifnull(oklad.personal_nadbav,0)+ifnull(oklad.perconal_imen_nadbav,0)
    +ifnull(oklad.premija_rabochim+oklad.sovmeshenie,0)) as sum_otdelenie, sotr.TopParent_Name, count(sotr.TopParent_Name) as ppls,
    sum(ifnull(oklad.oklad,0)+ifnull(oklad.kompens,0)+ifnull(oklad.dopl_stepen,0)
    +ifnull(oklad.personal_nadbav,0)+ifnull(oklad.perconal_imen_nadbav,0)
    +ifnull(oklad.premija_rabochim+oklad.sovmeshenie,0))/count(sotr.TopParent_Name) as mean
    from sotrudniki sotr
    left join oklad on sotr.tab_n=oklad.tab_n
    $INCLUDE utils.cfg[criteria] 
    group by sotr.TopParent_Name
 ;
   select concat("{ pname:'",sotr.TopParent_Name,"'",  
    Средняя зарплата ??
        ", v1:",sum(ifnull(oklad.oklad,0)+ifnull(oklad.kompens,0)+ifnull(oklad.dopl_stepen,0)) div (count(sotr.TopParent_Name)*1000),
    Средний возраст ??
        ", v2:",sum(((year(now())-year(sotr.dr)))) div count(sotr.TopParent_Name),
    Всего дюдей ??
        ", v3:",count(sotr.TopParent_Name),
        "},") 
        as d_otdelenie_age_salary
    from sotrudniki sotr
    left join oklad on sotr.tab_n=oklad.tab_n
    $INCLUDE utils.cfg[criteria] 
    group by sotr.TopParent_Name
 ;
   select concat("{ pname:'",sotr.subTopParent_Name,"'",  
    Средняя зарплата ??
        ", v1:",sum(ifnull(oklad.oklad,0)+ifnull(oklad.kompens,0)+ifnull(oklad.dopl_stepen,0)) div (count(sotr.subTopParent_Name)*1000),
    Средний возраст ??
        ", v2:",sum(((year(now())-year(sotr.dr)))) div count(sotr.subTopParent_Name),
    Всего дюдей ??
        ", v3:",count(sotr.subTopParent_Name),
        "},") 
        as d_otdel_age_salary
    from sotrudniki sotr
    left join oklad on sotr.tab_n=oklad.tab_n
    $INCLUDE utils.cfg[criteria] 
    group by sotr.subTopParent_Name
 ;

   select concat("{ pname:'",sotr.TopParent_Name,  "', value:",sum(ifnull(oklad.oklad,0)+ifnull(oklad.kompens,0)+ifnull(oklad.dopl_stepen,0)) div 1000,"},")
         as d_otdelenie
    from sotrudniki sotr
    left join oklad on sotr.tab_n=oklad.tab_n
    $INCLUDE utils.cfg[criteria] 
    group by sotr.TopParent_Name
 ;
   select concat("{ pname:'",sotr.subTopParent_Name,  "', value:",sum(ifnull(oklad.oklad,0)+ifnull(oklad.kompens,0)+ifnull(oklad.dopl_stepen,0)) div 1000,"},") 
    as d_otdel
    from sotrudniki sotr
    left join oklad on sotr.tab_n=oklad.tab_n
    $INCLUDE utils.cfg[criteria] 
    group by sotr.subTopParent_Name
 ;
   select concat("{ pname:'",sotr.category,"'",  
    Средняя зарплата ??
        ", v1:",sum(ifnull(oklad.oklad,0)+ifnull(oklad.kompens,0)+ifnull(oklad.dopl_stepen,0)) div (count(sotr.category)*1000),
    Средний возраст ??
        ", v2:",sum(((year(now())-year(sotr.dr)))) div count(sotr.category),
    Всего дюдей ??
        ", v3:",count(sotr.category)/10,
        "},") 
        as d_category
    from sotrudniki sotr
    left join oklad on sotr.tab_n=oklad.tab_n
    $INCLUDE utils.cfg[criteria] 
    group by sotr.category
 ;
Распределение по возрасту ??
    delete from tmp_age;
    insert into tmp_age  (
    select ((year(now())-year(sotr.dr)) div  10) * 10 as yo, oklad.oklad as oklad
    from sotrudniki sotr
    left join oklad on sotr.tab_n=oklad.tab_n
        $INCLUDE utils.cfg[criteria] 
    )
    ;
    select concat("{ pname:' ",yo,"-", yo+10,  "', value:",  sum(oklad) div(count(yo)*1000),  ", cnt:", count(yo),"},") as d_age
    from tmp_age
    group by yo
    ;
	 ;


[end]

[get otdels]
[end]

[get Totals]
   $LOG2 otdelenie #OTDELENIE# otdel #OTDEL#
    select sum(ifnull(oklad.oklad,0)+ifnull(oklad.kompens,0)+ifnull(oklad.dopl_stepen,0)
    +ifnull(oklad.personal_nadbav,0)+ifnull(oklad.perconal_imen_nadbav,0)
    +ifnull(oklad.premija_rabochim+oklad.sovmeshenie,0)) as SUM_OTDEL
    from sotrudniki sotr
    left join oklad on sotr.tab_n=oklad.tab_n
    where lab_id = 100000
    and sotr.subTopParent_name like '#otdel#'  ??otdel
    and sotr.topParent_name like '#otdelenie#%' ??otdelenie
    order by #srt# #desc#
    ;

    select sum(ifnull(oklad.oklad,0)+ifnull(oklad.kompens,0)+ifnull(oklad.dopl_stepen,0)
    +ifnull(oklad.personal_nadbav,0)+ifnull(oklad.perconal_imen_nadbav,0)
    +ifnull(oklad.premija_rabochim+oklad.sovmeshenie,0)) as SUM_OTDELENIE
    from sotrudniki sotr
    left join oklad on sotr.tab_n=oklad.tab_n
    where lab_id = 100000
    and sotr.topParent_name like '#otdelenie#%' ??otdelenie
    order by #srt# #desc#
    ;
    select sum(ifnull(oklad.oklad,0)+ifnull(oklad.kompens,0)+ifnull(oklad.dopl_stepen,0)
    +ifnull(oklad.personal_nadbav,0)+ifnull(oklad.perconal_imen_nadbav,0)
    +ifnull(oklad.premija_rabochim+oklad.sovmeshenie,0)) as SUM_CATEGORY
    from sotrudniki sotr
    left join oklad on sotr.tab_n=oklad.tab_n
    where lab_id = 100000
    and sotr.category like '#category#'  ??category
    and sotr.subTopParent_name like '#otdel#'  ??otdel
    and sotr.topParent_name like '#otdelenie#%' ??otdelenie
    order by #srt# #desc#
[end]

