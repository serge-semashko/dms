[parameters]
service=dubna.walt.service.Service
[end]

[report]
$SET_PARAMETERS_SESSION USER_ID=;
$INCLUDE [action] 
[end]

[action]
$INCLUDE [login] ??_OAUTH_ACTION=LOGIN&_OAUTH_JINRID
$INCLUDE [error] ??_OAUTH_ACTION=ERROR
$INCLUDE [logout] ??_OAUTH_ACTION=LOGOUT
[end]

[logout]
$SET_PARAMETERS_SESSION USER_ID=#GUEST_USER_ID#;USER_NAME=;USER_PERSON_ID=;USER_ROLE=;CurrentFolderId=;USER_PRIV=;
$INCLUDE [redirect if logout]
[end]

[error]
<script type="text/javascript">
top.window.location.href="?c=top&error=#_OAUTH_ERROR#";
</script>
[end]

[login]
$GET_DATA [check user]

$GET_DATA [new user] ??!_USER_ID
$GET_DATA [check user]??!_USER_ID

$INCLUDE [set session] ??_USER_ID
$INCLUDE [redirect if login ok] ??_USER_ID
$INCLUDE [redirect if login fail] ??!_USER_ID
[end]

[redirect if login ok]
<script type="text/javascript">
    top.window.location.href="?c=top&pp=#USER_PERSON_ID#";
</script>
[end]


[redirect if login fail]
<script type="text/javascript">
    top.window.location.href="?c=top";
</script>
[end]

[redirect if logout]
<script type="text/javascript">
    top.window.location.href="/pin/pin"
</script>
[end]

[set session]
$SET_PARAMETERS_SESSION USER_ID=#_USER_ID#; 
$SET_PARAMETERS_SESSION USER_PERSON_ID=#_USER_PERSON_ID#; 
$SET_PARAMETERS_SESSION USER_NAME=#_USER_NAME#; 
$SET_PARAMETERS_SESSION USER_ROLE=#_USER_ROLE#; 
$SET_PARAMETERS_SESSION CurrentFolderId=#_CurrentFolderId#; 
$SET_PARAMETERS_SESSION USER_PRIV=#_USER_PRIV#; 
[end]


[new user]
select id as PRSID, name as F, name1 as I, name2 as O from p_persons where kodfizlica is not null and kodfizlica=#_OAUTH_JINRID#;
insert into a_users set person_id=#PRSID# ,name1='#I#' ,name2='#O#' ,fname='#F#' ,login='jinr_sso_user_#_OAUTH_JINRID#' ,role='U' ,email='#_OAUTH_MAIL#', pwu='#_OAUTH_TMP_PASSWORD#';
commit;
[end]

[check user]
select 
au.ID as _USER_ID 
, concat(au.name1,' ', au.name2,' ',au.fname) as _USER_NAME
, au.person_id as _USER_PERSON_ID
, au.role as _USER_ROLE
, ppp.otdel as _CurrentFolderId 
, CASE au.role WHEN 'U' THEN 1
       WHEN 'CA' THEN 3
       WHEN 'SA' THEN 4
       ELSE 0
 END as _USER_PRIV
from a_users au
inner join p_persons pp on pp.Id=au.person_id 
left join p_persons_post ppp on ppp.Id=pp.Id and ppp.usl_rab not in (356,357)
where pp.kodfizlica = #_OAUTH_JINRID# 
and ppp.is_deleted != 1
limit 1
[end]
